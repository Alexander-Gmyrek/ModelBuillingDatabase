<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make 3 Tier Table</title>
</head>
<body>

<h1>Make 3 Tier Table</h1>

<div id="tableContainer"></div>

<button id="addTable">Add Table</button>
<button id="submit">Submit</button>

<script type="module">
    import {
        addEmployer,
        getFullTable
    } from './apiFunctions.js';

    let tableCount = 0; // Counter for tracking tables

    // Function to add a new column to a specific table
    function addColumn(tableId) {
        const table = document.getElementById(`editableTable_${tableId}`);
        const headerRow = table.rows[0];
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        const newHeaderCell = document.createElement('th');
        const newHeaderInput = document.createElement('input');
        newHeaderInput.type = 'text';
        newHeaderInput.value = 'New Column ' + (headerRow.cells.length - 5);
        newHeaderCell.appendChild(newHeaderInput);
        headerRow.insertBefore(newHeaderCell, headerRow.cells[headerRow.cells.length - 1]);

        for (let row of rows) {
            const newCell = row.insertCell(row.cells.length - 1);
            newCell.innerHTML = '<input type="number">';
        }
    }

    function deleteLastColumn(tableId) {
        const table = document.getElementById(`editableTable_${tableId}`);
        const headerRow = table.rows[0];
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        if (headerRow.cells.length <= 2) {
            alert("You cannot delete the last column!");
            return;
        }

        headerRow.deleteCell(headerRow.cells.length - 2);
        for (let row of rows) {
            row.deleteCell(row.cells.length - 2);
        }
    }

    function addTable() {
        tableCount++;
        const tableContainer = document.getElementById('tableContainer');
        const newTableWrapper = document.createElement('div');
        newTableWrapper.className = 'tableWrapper';
        newTableWrapper.id = `tableWrapper_${tableCount}`;
        newTableWrapper.innerHTML = `
            <h2>Table ${tableCount}: <input id="carrierName_${tableCount}" type="text" value="Carrier ${tableCount}"></h2>
            <table id="editableTable_${tableCount}">
                <thead>
                    <tr>
                        <th><input type="text" value="Plan Name"></th>
                        <th><input type="text" value="Funding EE"></th>
                        <th><input type="text" value="Funding E+1"></th>
                        <th><input type="text" value="Funding E+2"></th>
                        <th><input type="text" value="Admin Fee"></th>
                        <th></th> <!-- Placeholder for delete button -->
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" value="Plan A"></td>
                        <td><input type="number" value="$"></td>
                        <td><input type="number" value="$"></td>
                        <td><input type="number" value="$"></td>
                        <td><input type="number" value="$"></td>
                    </tr>
                </tbody>
            </table>
            <button onclick="addColumn(${tableCount})">Add Column</button>
            <button onclick="deleteLastColumn(${tableCount})">Delete Last Column</button>
        `;
        tableContainer.appendChild(newTableWrapper);
    }

    // Modified submitTable function
    async function submitTable() {
        // Retrieve the stored company data from localStorage
        const companyDataString = localStorage.getItem('companyData');
        if (!companyDataString) {
            console.error('No company data found in localStorage');
            return;
        }

        // Parse the stored JSON string into an object
        const companyData = JSON.parse(companyDataString);

        // Initialize arrays to hold the collected data
        const carriers = [];
        const tiers = [];
        const plans = [];

        // Track IDs for Carriers and Tiers
        let carrierID = 1;
        let tierID = 1;
        let planID = 1;

        for (let i = 1; i <= tableCount; i++) {
            // Collect carrier data
            const carrierName = document.getElementById(`carrierName_${i}`).value;
            const carrierObject = {
                "CarrierID": carrierID,
                // "EmployerID": 1, // Replace with actual EmployerID
                "CarrierName": carrierName,
            };
            carriers.push(carrierObject);

            // Collect tier data based on the fixed tiers
            const fixedTiers = ["Funding EE", "Funding E+1", "Funding E+2"];
            for (let j = 0; j < fixedTiers.length; j++) {
                const tierName = document.getElementById(`editableTable_${i}`).rows[0].cells[j + 1].getElementsByTagName('input')[0].value;
                const tierObject = {
                    "TierID": tierID,
                    //"EmployerID": 1, // Replace with actual EmployerID
                    "TierName": tierName,
                    "MaxAge": null, // Not applicable for fixed tiers
                    "MinAge": null  // Not applicable for fixed tiers
                };
                tiers.push(tierObject);
                tierID++;
            }

            // Collect plan data for each row in the table
            const table = document.getElementById(`editableTable_${i}`);
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let row of rows) {
                const inputs = row.getElementsByTagName('input');
                const planName = inputs[0].value;

                // Iterate over each input for funding details, except the last which is the admin fee
                for (let j = 1; j < inputs.length - 1; j++) {
                    // Create a plan object for each column
                    const tierName = tiers[j - 1].TierName;
                    const planObject = {
                        "PlanID": planID,
                        // "EmployerID": 1, // Replace with actual EmployerID
                        // "CarrierID": carrierID,
                        "CarrierName": carrierName,
                        //"PlanName": planName,
                        "FundingAmount": parseFloat(inputs[j].value) || 0,
                        "GrenzFee": parseFloat(inputs[inputs.length - 1].value) || 0,
                        "TierName": tierName
                    };
                    plans.push(planObject);
                    planID++;
                }
            }

            // Increment the carrier ID for the next table
            carrierID++;
        }

        // Add the collected data to the company data object
        companyData['Carriers'] = carriers;
        companyData['Tiers'] = tiers;
        companyData['Plans'] = plans;

        // Log the complete data to the console for debugging
        console.log('Complete Data:', companyData);

        // Send the complete data to the server
        try {
            const response = await addEmployer(companyData);
            // update the company id with the new_id from response
            companyData.EmployerID = response.new_id;
            // update the company data in local storage
            localStorage.setItem('companyData', JSON.stringify(companyData));
            let userAlert = 'Data submitted successfully!'
            // Notify of warnings
            if (response.warnings) {
                console.warn('Submission warnings:', response.warnings);
                //add warnings to local storage
                localStorage.setItem('warnings', JSON.stringify(response.warnings));
                // add the number of warnings to the user alert
                userAlert += '\nWarnings ' + countWarnings(response.warnings);
            }

            // check if there is missing data and alert the user
            //get the data
            const employerID = companyData.EmployerID;
            const missingData = await checkForMissingData(employerID, companyData);
            //add missing data to local storage
            localStorage.setItem('missingData', JSON.stringify(missingData));
            console.log(missingData);
            if (missingData.length > 0){
                for (let data of missingData){
                    for (let key in data){
                        userAlert += '\nMissing ' + key + ': ' + data[key].join(', ');
                    }
                }
            }

            alert(userAlert);

            // Optionally, clear the localStorage or redirect to another page
            //localStorage.removeItem('companyData'); // Clear the storage after submission

            //window.location.href = 'reviewcompany.html';

        } catch (error) {
            console.error('Error submitting data:', error);
            alert('Failed to submit data.');
        }
    }

    async function checkForMissingData(employerID,  companyData){
        //get the full table
        const myfullTable = await getFullTable('Employer', employerID);
        const fullTable = myfullTable.Element
        console.log(fullTable);
        console.log(JSON.stringify(fullTable));
        let missingData = [];
        //check for missing carriers
        const missingCarriers = companyData.Carriers.filter(c => !fullTable.Carriers.find(fc => fc.CarrierName === c.CarrierName));
        const missingCarrierNames = missingCarriers.map(c => c.CarrierName);
        missingData.push({"Carriers": missingCarrierNames});

        //check for missing tiers
        const missingTiers = companyData.Tiers.filter(t => !fullTable.Tiers.find(ft => ft.TierName === t.TierName));
        const missingTierNames = missingTiers.map(t => t.TierName);
        missingData.push({"Tiers": missingTierNames});

        //check for missing plans
        //for (let plan of companyData.Plans){
        //    if (!fullTable.Plans.find(p => p.PlanName === plan.PlanName)){
        //        missingData.push(plan.PlanName);
        //    }
        //}

        //check for missing employees
        const missingEmployees = companyData.Employees.filter(e => !fullTable.Employees.find(fe => fe.EmployeeName === e.EmployeeName));
        const missingEmployeeNames = missingEmployees.map(e => e.EmployeeName);
        missingData.push({"Employees": missingEmployeeNames});

        //check for missing dependents
        const allMissingDependents = [];
        const allMissingEmployeePlans = [];
        for (let employee of companyData.Employees){
            const fullEmployee = fullTable.Employees.find(e => e.EmployeeName === employee.EmployeeName);
            if (!fullEmployee){
                continue;
            }else{
                //check for missing dependents
                if(employee.Dependents){
                    let missingDependents = [];
                    let missingDependentNames = [];
                    missingDependents = employee.Dependents.filter(d => !fullEmployee.Dependents.find(fd => fd.DependentName === d.DependentName));
                    missingDependentNames = missingDependents.map(d => d.DependentName);
                    if(missingDependentNames.length > 0){
                        allMissingDependents.push({[fullEmployee.EmployeeFullName]: missingDependentNames});
                    }
                    
                }
                

                // Check to make sure the employee has an employee plan
                if (!fullEmployee.EmployeePlan){
                    allMissingEmployeePlans.push(fullEmployee.EmployeeName);
                }
            }
        }
        missingData.push({"Dependents": allMissingDependents});
        missingData.push({"EmployeePlan": allMissingEmployeePlans});
        return missingData;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        addTable();
        // make the add tabel button add a new table
        document.getElementById('addTable').addEventListener('click', addTable);
        // make the submit button submit the data
        document.getElementById('submit').addEventListener('click', submitTable);
    });

    function countWarnings(warnings){
        let count = 0;
        for (let warning in warnings){
            if (warnings[warning].hasOwnProperty('toString')){
                count += countWarnings(warning[warning]);
            } else {
                count++;
            } 
        }
        return count;
    }

    
</script>

</body>
</html>
// do imports