<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editable Table with Add and Delete Row Feature</title>
</head>
<body>

<!-- Title of the table -->
<h2>Editable Table with Add and Delete Row Feature</h2>

<!-- Table structure with header and initial rows -->
<table id="editableTable">
    <thead>
        <tr>
            <th>Plan Name</th>
            <th>Funding EE</th>
            <th>Funding E+1</th>
            <th>Funding E+2</th>
            <th>Admin Fee</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        <!-- Initial row with inputs and delete button -->
        <tr>
            <td><input type="text" value="Plan A"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><button onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <!-- Another initial row with inputs and delete button -->
        <tr>
            <td><input type="text" value="Plan B"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><button onclick="deleteRow(this)">Delete</button></td>
        </tr>
        <!-- Another initial row with inputs and delete button -->
        <tr>
            <td><input type="text" value="Plan C"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><input type="number" value="$"></td>
            <td><button onclick="deleteRow(this)">Delete</button></td>
        </tr>
    </tbody>
</table>

<!-- Button to add new rows -->
<button onclick="addRow()">Add Row</button>
<!-- Button to submit the table data -->
<button onclick="submitTable()">Submit</button>

<script>
    // Function to add a new row to the table
    function addRow() {
        // Get the table body
        const table = document.getElementById('editableTable').getElementsByTagName('tbody')[0];
        // Insert a new row at the end
        const newRow = table.insertRow();
        
        // Loop through the columns to add input fields and a delete button
        for (let i = 0; i < 6; i++) {
            // Insert a new cell in the row
            const newCell = newRow.insertCell(i);
            // Add appropriate input field or button based on the column index
            if (i === 0) {
                // First column: text input for plan name
                newCell.innerHTML = '<input type="text">';
            } else if (i === 5) {
                // Last column: delete button
                newCell.innerHTML = '<button onclick="deleteRow(this)">Delete</button>';
            } else {
                // Other columns: number input fields
                newCell.innerHTML = '<input type="number">';
            }
        }
    }

    // Function to delete a row from the table
    function deleteRow(button) {
        // Get the row containing the button
        const row = button.parentNode.parentNode;
        // Remove the row from the table
        row.parentNode.removeChild(row);
    }

    // Function to submit the table data
    async function submitTable() {
        // Retrieve the stored data object from localStorage
        const companyDataString = localStorage.getItem('companyData');
        if (!companyDataString) {
            console.error('No company data found in localStorage');
            return;
        }

        // Parse the stored JSON string into an object
        const companyData = JSON.parse(companyDataString);

        // Get the table
        const table = document.getElementById('editableTable');
        // Get all the rows in the table body
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        // Initialize an array to hold the table data
        const tableData = [];

        // Loop through each row to collect the input values
        for (let row of rows) {
            // Get all input fields in the row
            const inputs = row.getElementsByTagName('input');
            // Create an object to hold the row data
            const rowData = {
                planName: inputs[0].value,
                fundingEE: inputs[1].value,
                fundingE1: inputs[2].value,
                fundingE2: inputs[3].value,
                adminFee: inputs[4].value
            };
            // Add the row data to the array
            tableData.push(rowData);
        }

        // Add the table data to the company data object
        companyData['Plans'] = tableData;

        // Log the complete data to the console
        console.log('Complete Data:', companyData);

        // Send the complete data to the server
        try {
            await addEmployer(companyData);
            alert('Data submitted successfully!');
            // Optionally, clear the localStorage or redirect to another page
            localStorage.removeItem('companyData'); // Clear the storage after submission
        } catch (error) {
            console.error('Error submitting data:', error);
            alert('Failed to submit data.');
        }
    }

    // Placeholder for the apiFunctions.js methods.
    // In a real scenario, these would be imported from the actual `apiFunctions.js` file.
    const BASE_URL = "http://localhost:5000";

    // Helper function to make API requests
    async function apiRequest(endpoint, method = "GET", body = null) {
        const options = {
            method,
            headers: {
                "Content-Type": "application/json"
            }
        };

        if (body) {
            options.body = JSON.stringify(body);
        }

        try {
            const response = await fetch(`${BASE_URL}${endpoint}`, options);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error("API Request Error:", error);
            throw error;
        }
    }

    // Function to add an employer
    async function addEmployer(employerJson) {
        return await apiRequest("/employer", "POST", employerJson);
    }
</script>

</body>
</html>
